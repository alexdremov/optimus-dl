name: Docker Image CI

permissions:
  contents: read

on:
  release:
    types: [published]
  pull_request:
    paths:
      - 'docker/**'
      - '.github/workflows/docker-image.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # -----------------------------------------------------------------
  # Stage 1: Generate version & branch names centrally
  # -----------------------------------------------------------------
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.prep.outputs.version }}
      branch_name: ${{ steps.prep.outputs.branch_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build and get version
        id: prep
        run: |
          pip install build setuptools_scm
          VERSION=$(python -m setuptools_scm)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BRANCH_NAME=$(echo "${{ github.head_ref }}" | sed 's/\//-/g')
            echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          else
            echo "branch_name=" >> $GITHUB_OUTPUT
          fi

  # -----------------------------------------------------------------
  # Stage 2: Build & Push per platform (Parallelized via Matrix)
  # -----------------------------------------------------------------
  build:
    needs: prepare
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        platform: [linux/amd64, linux/arm64]
        include:
          - platform: linux/amd64
            arch: amd64
            runner: ubuntu-24.04
          - platform: linux/arm64
            arch: arm64
            runner: ubuntu-24.04-arm
    steps:
      - name: Delete huge unnecessary tools folder
        run: |
          rm -rf /opt/hostedtoolcache
          rm -rf "/usr/local/share/boost"
          rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # Use a custom builder that allows host volume mounting for persistent cache
          driver: docker-container

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Aggressive free disk space
        run: |
          echo "################################"
          echo "Disk usage BEFORE cleanup:"
          echo "################################"
          df -h

          echo "Removing hosted toolcache..."
          rm -rf /opt/hostedtoolcache || true

          echo "Removing .NET..."
          rm -rf /usr/share/dotnet || true

          echo "Removing Android SDK..."
          rm -rf /usr/local/lib/android || true

          echo "Removing GHC / Haskell..."
          rm -rf /opt/ghc || true
          rm -rf /usr/local/.ghcup || true

          echo "Docker prune (just in case runner had leftovers)..."
          docker container prune -f || true
          docker image prune -af || true
          docker volume prune -f || true

          echo "################################"
          echo "Disk usage AFTER cleanup:"
          echo "################################"
          df -h

      - name: Load ccache from registry
        run: |
          mkdir -p /tmp/ccache_root
          if docker pull alexdremov/optimus-dl-ccache:${{ matrix.arch }}; then
            echo "Registry ccache found. Loading..."
            docker create --name ccache-loader alexdremov/optimus-dl-ccache:${{ matrix.arch }} true
            docker cp ccache-loader:/root/.ccache /tmp/ccache_root
            docker rm ccache-loader
          else
            echo "No ccache image found in registry, starting fresh."
          fi
          ls -R /tmp/ccache_root | head -n 20

      - name: Seed internal ccache mount
        run: |
          ARCH="${{ matrix.arch }}"
          docker buildx bake -f docker/docker-bake.hcl ccache-seed \
            --allow fs.read=/tmp/ccache_root \
            --set "*.args.ARCH=${ARCH}" \
            --set "*.args.CACHE_BUSTER=$(date +%s)" \
            --set "*.platform=${{ matrix.platform }}" \
            --set "*.contexts.ccache_src=/tmp/ccache_root"

      - name: Docker Build & Push Platform-Specific Image
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          BRANCH_NAME="${{ needs.prepare.outputs.branch_name }}"
          ARCH="${{ matrix.arch }}"

          echo "Building Version: $VERSION for Architecture: $ARCH on ${{ matrix.runner }}"

          # Create arch-suffixed tags
          TAGS=("alexdremov/optimus-dl:${VERSION}-${ARCH}")
          TAGS_INTERACTIVE=("alexdremov/optimus-dl:interactive-${VERSION}-${ARCH}")

          if [[ "${{ github.event_name }}" == "release" ]]; then
            TAGS+=("alexdremov/optimus-dl:latest-${ARCH}")
            TAGS_INTERACTIVE+=("alexdremov/optimus-dl:interactive-latest-${ARCH}")
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            TAGS+=("alexdremov/optimus-dl:branch-${BRANCH_NAME}-${ARCH}")
            TAGS_INTERACTIVE+=("alexdremov/optimus-dl:interactive-branch-${BRANCH_NAME}-${ARCH}")
          fi

          BAKE_TAG_ARGS=""
          for tag in "${TAGS[@]}"; do
            BAKE_TAG_ARGS="${BAKE_TAG_ARGS} --set optimus-dl.tags=${tag}"
          done
          for tag in "${TAGS_INTERACTIVE[@]}"; do
            BAKE_TAG_ARGS="${BAKE_TAG_ARGS} --set optimus-dl-interactive.tags=${tag}"
          done

          # Define the bake command as a string for reuse
          BAKE_CMD="docker buildx bake -f docker/docker-bake.hcl \
            --allow network.host \
            --allow fs.read=/tmp/ccache_root \
            --push \
            --set \"*.args.VERSION=${VERSION}\" \
            --set \"*.args.ARCH=${ARCH}\" \
            --set \"*.platform=${{ matrix.platform }}\" \
            ${BAKE_TAG_ARGS} \
            --set \"*.cache-from=type=registry,ref=alexdremov/optimus-dl:buildcache-${ARCH}\" \
            --set \"*.cache-to=type=registry,ref=alexdremov/optimus-dl:buildcache-${ARCH},mode=max\""

          echo "Previewing build configuration:"
          eval "$BAKE_CMD --print"

          echo "Starting build and push:"
          eval "$BAKE_CMD"


      - name: Save updated ccache to registry
        if: always()
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          ARCH="${{ matrix.arch }}"

          echo "Exporting and pushing ccache to registry..."

          # We use the ccache-export target which handles the push natively
          docker buildx bake -f docker/docker-bake.hcl ccache-export \
            --allow network.host \
            --push \
            --allow=fs.read=/tmp/ccache_root
            --set "*.platform=${{ matrix.platform }}" \
            --set "*.args.ARCH=${ARCH}" \
            --set "*.args.CACHE_BUSTER=$(date +%s)" \
            --set "*.contexts.ccache_src=/tmp/ccache_root" || echo "Ccache preservation failed, but continuing..."

  # -----------------------------------------------------------------
  # Stage 3: Merge manifest tags
  # -----------------------------------------------------------------
  merge:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create and Push Multi-Platform Manifests
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          BRANCH_NAME="${{ needs.prepare.outputs.branch_name }}"

          # Reconstruct the BASE tags without the arch suffix
          TAGS=("alexdremov/optimus-dl:${VERSION}")
          TAGS_INTERACTIVE=("alexdremov/optimus-dl:interactive-${VERSION}")

          if [[ "${{ github.event_name }}" == "release" ]]; then
            TAGS+=("alexdremov/optimus-dl:latest")
            TAGS_INTERACTIVE+=("alexdremov/optimus-dl:interactive-latest")
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            TAGS+=("alexdremov/optimus-dl:branch-${BRANCH_NAME}")
            TAGS_INTERACTIVE+=("alexdremov/optimus-dl:interactive-branch-${BRANCH_NAME}")
          fi

          # Function to merge tags using buildx imagetools
          merge_manifest() {
            local base_tag=$1
            echo "Creating manifest for ${base_tag}..."
            docker buildx imagetools create -t "${base_tag}" \
              "${base_tag}-amd64" \
              "${base_tag}-arm64"
          }

          for tag in "${TAGS[@]}"; do
            merge_manifest "$tag"
          done

          for tag in "${TAGS_INTERACTIVE[@]}"; do
            merge_manifest "$tag"
          done
